package com.tezov.tuucho.core.data.parser.rectifier.texts

import com.tezov.tuucho.core.data.di.MaterialRectifierModule.Name
import com.tezov.tuucho.core.data.parser._schema.TextSchema
import com.tezov.tuucho.core.data.parser._schema.TextSchema.Companion.defaultPut
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idAddGroup
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idHasGroup
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idObjectOrNull
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idPut
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idPutNullIfMissing
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idPutObject
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idPutSource
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idPutValue
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idRawOrNull
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idSourceOrNull
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.idValueOrNull
import com.tezov.tuucho.core.data.parser._schema.header.HeaderIdSchema.Companion.isIdAutoGenerated
import com.tezov.tuucho.core.data.parser._schema.header.HeaderTypeSchema.Companion.typePut
import com.tezov.tuucho.core.data.parser._system.JsonElementPath
import com.tezov.tuucho.core.data.parser._system.Matcher
import com.tezov.tuucho.core.data.parser._system.Matcher.Companion.isTypeOf
import com.tezov.tuucho.core.data.parser._system.find
import com.tezov.tuucho.core.data.parser._system.toPath
import com.tezov.tuucho.core.data.parser.rectifier.Rectifier
import com.tezov.tuucho.core.data.parser.rectifier.RectifierBase
import com.tezov.tuucho.core.domain.model._system.string
import kotlinx.serialization.json.JsonArray
import kotlinx.serialization.json.JsonElement
import kotlinx.serialization.json.JsonObject
import kotlinx.serialization.json.jsonArray
import kotlinx.serialization.json.jsonObject
import org.koin.core.component.inject

class TextRectifier : RectifierBase() {

    override val matchers: List<Matcher> by inject(
        Name.Matcher.TEXT
    )

    override val childProcessors: List<Rectifier> by inject(
        Name.Processor.TEXT
    )

    override fun accept(
        path: JsonElementPath, element: JsonElement
    ) = (path.lastSegment() == null &&
            element is JsonArray &&
            element.all { it.isTypeOf(TextSchema.Default.type) }) || super.accept(path, element)

    override fun beforeAlterArray(
        path: JsonElementPath,
        element: JsonElement
    ) = with(element.find(path).jsonArray) {
        JsonArray(this.map { process("".toPath(), it) })
    }

    override fun beforeAlterObject(
        path: JsonElementPath,
        element: JsonElement
    ) = element.find(path).jsonObject.toMutableMap().apply {
        typePut(TextSchema.Default.type)
        idPutNullIfMissing()
    }.let(::JsonObject)

    override fun beforeAlterPrimitive(
        path: JsonElementPath,
        element: JsonElement
    ) = mutableMapOf<String, JsonElement>()
        .apply {
            typePut(TextSchema.Default.type)
            idPutNullIfMissing()
            defaultPut(element.find(path).string)
        }
        .let(::JsonObject)

    override fun afterAlterObject(
        path: JsonElementPath,
        element: JsonElement
    ): JsonElement? = with(element.find(path).jsonObject) {
        val (value, source) = rectifyIds(this)
        if (value == null && source == null) return null
        idObjectOrNull?.let { idObject ->
            val idUpdated = idObject.toMutableMap().apply {
                when {
                    value != null && source != null -> idPut(value, source)
                    value != null -> idPutValue(value)
                    else -> idPutSource(source)
                }
            }
            toMutableMap()
                .apply { idPutObject(idUpdated) }
                .let(::JsonObject)
        }
    }

    private fun rectifyIds(current: JsonObject): Pair<String?, String?> {
        var value: String?
        var source: String?
        with(current) {
            with(idRawOrNull as JsonObject) {
                value = idValueOrNull?.takeIf { !it.idHasGroup() && !isIdAutoGenerated }
                    ?.idAddGroup(TextSchema.Default.Group.common)
                source = idSourceOrNull?.takeIf { !it.idHasGroup() }
                    ?.idAddGroup(TextSchema.Default.Group.common)
            }
        }
        return value to source
    }

}